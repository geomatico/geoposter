<!DOCTYPE html> 
<html> 
<head> 
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoPoster</title>
    <link rel="shortcut icon" href="img/favicon.ico" />

    <link rel="stylesheet" type="text/css" href="css/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap-responsive.css" />
    <link rel="stylesheet" type="text/css" href="bootstrap-editable/css/bootstrap-editable.css" />
    <link rel="stylesheet" type="text/css" href="bootstrap-editable/wysihtml5/bootstrap-wysihtml5-0.0.2/bootstrap-wysihtml5-0.0.2.css" />

    <script type="text/javascript" src="js/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="js/leaflet.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="bootstrap-editable/js/bootstrap-editable.min.js"></script>
    <script src="bootstrap-editable/wysihtml5/bootstrap-wysihtml5-0.0.2/wysihtml5-0.3.0.js"></script>  
    <script src="bootstrap-editable/wysihtml5/bootstrap-wysihtml5-0.0.2/bootstrap-wysihtml5-0.0.2.js"></script>
    <script src="bootstrap-editable/wysihtml5/wysihtml5.js"></script>

    <script type="text/javascript" src="data/serverData.js"></script>

    <style>
        html {
            height: 100%;
        }

        body {
            height: 95%;
            padding-bottom:60px;
            -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
            -moz-box-sizing: border-box;    /* Firefox, other Gecko */
            box-sizing: border-box;         /* Opera/IE 8+ */
        }

        #map {
            background: gray;
            width: 100%;
            height: 100%;
            min-height: 100%;
            display: block;
        }
        .fill { 
            min-height: 100%;
            height: 100%;
        }

        .editable-click, .leaflet-marker-icon {
            border: 2px solid transparent;
            text-decoration: none;
        }

        .editable-click:hover, .leaflet-marker-selected:hover {
            border: 2px dashed #CCCCCC;
            text-decoration: none;
        }

        .thumbnail.editable, .thumbnail.editable:after {
            border: 1px solid #CCCCCC;
        }

        .thumbnail.editable:after {
            background-color: #F5F5F5;
            border-radius: 0 4px 0 4px;
            bottom: -3px;
            color: #9DA0A4;
            content: "Editable!";
            font-size: 12px;
            font-weight: bold;
            left: -5px;
            padding: 3px 7px;
            position: relative;
        }

        .thumbnail.editable {
            margin-top: 10px;
        }

    </style>
    <script>
        var map;
        var data;
        var selectedItem;

        var defaultIconUrl = 'map-icons/pins/48/pin2.png';
        var selectedIconUrl = 'map-icons/pins/48/pin1.png';

        function init() {
            cloudmadeUrl = 'http://{s}.tile.cloudmade.com/f9b48b21a87048bfb118148491d22ec5/{styleId}/256/{z}/{x}/{y}.png',
            cloudmadeAttribution = 'Map data &copy; OpenStreetMap contributors, imagery &copy; CloudMade';

            ride = L.tileLayer(cloudmadeUrl, {styleId: 1714, attribution: cloudmadeAttribution});
            minimal = L.tileLayer(cloudmadeUrl, {styleId: 22677, attribution: cloudmadeAttribution});
            midnight = L.tileLayer(cloudmadeUrl, {styleId: 999, attribution: cloudmadeAttribution});
            
            map = L.map('map', {
                center: [41.4504467428547, 2.1900558471679688],
                zoom: 12,
                maxBounds: [[-90, -180], [90, 180]],
                layers: [ride]
            });

            L.control.layers({
                "Ride": ride,
                "Minimal": minimal,
                "Midnight": midnight
            }).addTo(map); 

            load();

            $('#title').editable({
                mode: 'popup',
                placement: 'left',
                showbuttons: "bottom",
                animation: true,
                unsavedclass: null
            }).on('save', updateTitle);

            $('#content').editable({
                mode: 'popup',
                placement: 'left',
                showbuttons: "bottom",
                animation: true,
                unsavedclass: null,
                wysihtml5: {
                    "font-styles": false, //Font styling, e.g. h1, h2, etc. Default true
                    "emphasis": true, //Italics, bold, etc. Default true
                    "lists": true, //(Un)ordered lists, e.g. Bullets, Numbers. Default true
                    "html": false, //Button which allows you to edit the generated HTML. Default false
                    "link": true, //Button to insert a link. Default true
                    "image": true, //Button to insert an image. Default true,
                    "color": false //Button to change color of font  
                }
            }).on('save', updateContent);
        }

        function load() {
            data = $.parseJSON(localStorage.getItem("data")) || serverData;

            var defaultIcon = L.icon({
                iconUrl: defaultIconUrl,
                iconSize: [48, 48],
                iconAnchor: [24, 48]
            });

            L.geoJson(data, {
                pointToLayer: function (feature, latlng) {
                    return L.marker(latlng, {
                        title: feature.properties.Name,
                        icon: defaultIcon,
                        riseOnHover: true
                    });
                },
                onEachFeature: function(feature, marker) {
                    if (feature.properties && feature.properties.Description && feature.properties.Name) {
                        marker.title = feature.properties.Name;
                        marker.content = feature.properties.Description;
                        marker.on('click', function(e) {
                            selectItem(e.target);
                        });
                        marker.on('dragstart', function(e){
                            selectItem(e.target);
                        });
                        marker.on('dragend', function(e){
                            updateFeatureLocation(e.target);
                        });
                    }
                }
            }).addTo(map);
        }

        function save() {
            localStorage.setItem("data", JSON.stringify(data));
        }

        function selectItem(item) {
            if (selectedItem) {
                selectedItem.dragging.disable();
                $(selectedItem._icon).removeClass("leaflet-marker-selected");
                selectedItem._icon.src = defaultIconUrl;
            }
            selectedItem = item;
            $(selectedItem._icon).addClass("leaflet-marker-selected");
            selectedItem._icon.src = selectedIconUrl;
            selectedItem.dragging.enable();

            $("#info").show();
            $("#title").editable('setValue', item.title);
            $("#content").editable('setValue', item.content);
        }

        function updateFeatureLocation(item) {
            getSelectedFeature().geometry.coordinates = [item.getLatLng().lng, item.getLatLng().lat];
            save();
        }

        function updateTitle(e, params) {
            getSelectedFeature().properties.Name = params.newValue;
            save();
            selectedItem.title = params.newValue;
            selectedItem._icon.title = params.newValue; // Ugly, but no accessor method
        }

        function updateContent(e, params) {
            getSelectedFeature().properties.Description = params.newValue;
            save();
            selectedItem.content = params.newValue;
        }

        function getSelectedFeature() {
            return data.features.filter(function (feature) {
              return feature.properties.Name == selectedItem.title;
            })[0];
        }

    </script>
</head>
<body onload="init()">
    <div class="container-fluid" style="margin-top:15px;">
        <div class="navbar navbar-inverse">
            <div class="navbar-inner">
                <div class="container">
                    <a class="brand" href="#">GeoPoster</a>
                    <small>&copy; Oscar Fonts</small>
                    <form class="navbar-search pull-right">
                        <input type="text" class="search-query" placeholder="Cerca">
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid fill">
        <div class="row-fluid fill">
            <div class="span9 thumbnail fill">
                <div id="map"></div>
            </div>
            <div class="span3">
                <button class="btn btn-large btn-block btn-primary"> Nou <img src="map-icons/pins/24/pin1.png" /></button>
                <div id="info" style="display:none;" class="thumbnail editable">
                    <h3 id="title" data-type="text" data-original-title="Títol">Títol...</h3>
                    <div id="content" data-type="wysihtml5" data-original-title="Continguts">Continguts...</div>
                </div>
            </div>
        </div>
    </div>
</body>    
</html>